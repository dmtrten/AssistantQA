<!DOCTYPE html>
<html lang="ru">
 <head>
  <meta charset="utf-8"/>
  <title>
   –§–æ—Ä–º–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
  </title>
  <style>
   body { font-family: sans-serif; margin: 20px; }
    .step, .info { border: 1px solid #ddd; padding: 10px; margin-top: 10px; border-radius: 5px; background: #f9f9f9; position: relative; }
    .step-title { margin-top: 10px; }
    .btn { margin-top: 10px; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; }
    .add { background-color: #3498db; color: white; }
    .download { background-color: #2ecc71; color: white; margin-top: 15px; }
    .delete { background-color: #e74c3c; color: white; }
    .preview { margin-top: 10px; max-width: 200px; max-height: 200px; }
    #title { width: 100%; padding: 8px; }
  </style>
 </head>
 <body>
  <h1>
   –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è Bot AI
  </h1>
  <input id="title" maxlength="70" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, —Ñ–∞–π–ª–∞ (–ú–∞–∫—Å–∏–º—É–º 70 —Å–∏–º–≤–æ–ª–æ–≤)" type="text"/>
  <br/>
  <br/>
  <textarea id="description" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: –¥–ª—è –∫–æ–≥–æ, –∑–∞—á–µ–º, —á—Ç–æ –ø–æ–ª—É—á–∏—Ç—Å—è –≤ –∏—Ç–æ–≥–µ." style="width: 100%; height: 60px; padding: 8px;"></textarea>
  <div id="steps">
  </div>
  <button class="btn add" onclick="addStep()">
   ‚ûï –î–æ–±–∞–≤–∏—Ç—å —à–∞–≥
  </button>
  <div class="info">
   <h3>
    ‚ÑπÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
   </h3>
   <textarea id="additionalInfo" placeholder="–ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî —Å—Å—ã–ª–∫–∏, —Å–æ–≤–µ—Ç—ã, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏ —Ç.–¥." style="width: 100%; height: 80px; padding: 8px;"></textarea>
  </div>
  <button class="btn download" onclick="downloadMarkdown()">
   üì• –°–∫–∞—á–∞—Ç—å Markdown
  </button>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js">
  </script>
  <script>
   let stepCount = 0;
    const stepsContainer = document.getElementById('steps');

    function addStep() {
      stepCount++;
      const stepDiv = document.createElement('div');
      stepDiv.className = 'step';
      stepDiv.innerHTML = `
        <h3>–®–∞–≥ ${stepCount}</h3>
        <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–≥–∞" style="width: 100%; padding: 6px;" />
        <br>
        <textarea placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —à–∞–≥–∞" style="width: 100%; height: 50px; margin-top: 5px; padding: 6px;"></textarea>
<select style="width: 100%; margin-top: 5px; padding: 6px;">
  <option value="normal">–û–±—ã—á–Ω—ã–π —à–∞–≥</option>
  <option value="condition">–£—Å–ª–æ–≤–∏–µ</option>
  <option value="alternative">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø—É—Ç—å</option>
  <option value="branch">–í–µ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞</option>
</select>
<br>
<input type="text" placeholder="–£—Å–ª–æ–≤–∏–µ –ø–æ–∫–∞–∑–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)" style="width: 100%; padding: 6px; margin-top: 5px;" />
<br>
<input type="text" placeholder="–°–≤—è–∑–∞–Ω —Å —à–∞–≥–æ–º ‚Ññ" style="width: 100%; padding: 6px; margin-top: 5px;" />
<br>
<input type="text" placeholder="–ü–æ—è—Å–Ω–µ–Ω–∏–µ –∫ —à–∞–≥—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" style="width: 100%; padding: 6px; margin-top: 5px;" />
<br>
<label><input type="checkbox" style="margin-top: 5px;"> –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —à–∞–≥</label>

        <br>
        <input type="file" accept="image/*" onchange="uploadImage(this)" />
        <p class="resultLink"></p>
        <img class="preview" style="display:none;" />
        <div class="step-buttons" style="margin-top:10px;">
          <button class="btn delete" onclick="deleteStep(this)">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —à–∞–≥</button>
        </div>
      `;
      stepsContainer.appendChild(stepDiv);
      updateStepNumbers();
    }

    function deleteStep(button) {
      const step = button.closest('.step');
      step.remove();
      stepCount--;
      updateStepNumbers();
    }

    function updateStepNumbers() {
      const steps = document.querySelectorAll('.step');
      steps.forEach((step, index) => {
        step.querySelector('h3').textContent = `–®–∞–≥ ${index + 1}`;
      });
    }

    async function uploadImage(input) {
      const step = input.closest('.step');
      const preview = step.querySelector('.preview');
      const resultLink = step.querySelector('.resultLink');

      if (!input.files[0]) return;

      const file = input.files[0];

      let signatureResponse = await fetch('https://imagekit-signature-1047049025362.us-central1.run.app/get-signature');
      let signatureData = await signatureResponse.json();

      const formData = new FormData();
      formData.append("file", file);
      formData.append("publicKey", "public_YUpQu5P5d2jc2KpRB+s0OGVQsqM=");
      formData.append("signature", signatureData.signature);
      formData.append("expire", signatureData.expire);
      formData.append("token", signatureData.token);
      formData.append("fileName", file.name);

      fetch('https://upload.imagekit.io/api/v1/files/upload', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.url) {
          const optimizedUrl = data.url + '?tr=w-800,q-70,fo-auto';
          resultLink.innerHTML = `<strong>–°—Å—ã–ª–∫–∞:</strong> <a href="${optimizedUrl}" target="_blank">${optimizedUrl}</a>`;
          preview.src = optimizedUrl;
          preview.style.display = 'block';
        } else {
          resultLink.innerText = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + JSON.stringify(data);
        }
      })
      .catch(error => {
        resultLink.innerText = "–û—à–∏–±–∫–∞: " + error.message;
      });
    }

    function sanitizeFileName(name) {
      return name.trim().replace(/[^a-z0-9–∞-—è—ë_\- ]/gi, '').replace(/ +/g, '_').slice(0, 70);
    }

    function downloadMarkdown() {
      const title = document.getElementById('title').value;
      const description = document.getElementById('description').value;
      const additionalInfo = document.getElementById('additionalInfo').value;
      const steps = document.querySelectorAll('.step');
      let md = `# ${title}

> ${description}

## –®–∞–≥–∏

`;

      steps.forEach((step, i) => {
        const stepTitle = step.querySelector('input[type="text"]').value;
        const stepDesc = step.querySelector('textarea').value;
        const imgLink = step.querySelector('.resultLink a');
        md += `### ${i + 1}. ${stepTitle}

${stepDesc}

`;
        if (imgLink) {
          md += `–°–º. –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∏–∂–µ ‚¨áÔ∏è\n![–®–∞–≥ ${i + 1}](${imgLink.href})\n\n`;
        }
        md += `---

`;
      });

      md += `## ‚ÑπÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

${additionalInfo}
`;

      const filename = sanitizeFileName(title) || 'instruction';
      const blob = new Blob([md], { type: "text/markdown" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${filename}.md`;
      a.click();
      URL.revokeObjectURL(url);
    }

    new Sortable(stepsContainer, {
      animation: 150,
      onEnd: function () {
        updateStepNumbers();
      }
    });

    addStep();
  </script>
  <input accept=".json" id="jsonDraftFile" onchange="handleJsonDraft(event)" style="display:none;" type="file"/>
  <button class="btn download" onclick="document.getElementById('jsonDraftFile').click()">
   üìÇ –û—Ç–∫—Ä—ã—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫
  </button>
  <button class="btn download" onclick="downloadJsonDraft()" style=";display:none;">
   üíæ –°–∫–∞—á–∞—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫
  </button>
  <script>
   async function handleJsonDraft(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      document.getElementById('title').value = data.title || '';
      document.getElementById('description').value = data.description || '';
      document.getElementById('additionalInfo').value = data.additional || '';
      document.getElementById('steps').innerHTML = '';
      stepCount = 0;
      (data.steps || []).forEach(step => {
        addStep(step.title, step.desc, step.img);
      });
    } catch (err) {
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–Ω–æ–≤–∏–∫–∞: ' + err.message);
    }
  };
  reader.readAsText(file);
}

function downloadJsonDraft() {
  const title = document.getElementById('title').value;
  const description = document.getElementById('description').value;
  const additionalInfo = document.getElementById('additionalInfo').value;
  const steps = document.querySelectorAll('.step');

  const json = {
    title,
    description,
    additional: additionalInfo,
    steps: []
  };

  steps.forEach((step) => {
    const stepTitle = step.querySelector('input[type="text"]').value;
    const stepDesc = step.querySelector('textarea').value;
    const imgLink = step.querySelector('.resultLink a');
    const img = imgLink ? imgLink.href : '';
    json.steps.push({ title: stepTitle, desc: stepDesc, img });
  });

  const blob = new Blob([JSON.stringify(json, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = (title ? title.replace(/[^a-z0-9–∞-—è—ë_\- ]/gi, '').slice(0, 70) : 'instruction') + '.json';
  a.click();
  URL.revokeObjectURL(url);
}
  </script>
  <script>
   function addStepFromDraft(title = '', desc = '', img = '') {
  stepCount++;
  const stepDiv = document.createElement('div');
  stepDiv.className = 'step';
  stepDiv.innerHTML = `
    <h3>–®–∞–≥ ${stepCount}</h3>
    <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–≥–∞" style="width: 100%; padding: 6px;" value="${title}" />
    <br>
    <textarea placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —à–∞–≥–∞" style="width: 100%; height: 50px; margin-top: 5px; padding: 6px;">${desc}</textarea>
    <br>
    <input type="file" accept="image/*" onchange="uploadImage(this)" />
    <p class="resultLink">${img ? '<a href="'+img+'" target="_blank">'+img+'</a>' : ''}</p>
    <img class="preview" style="display:${img ? 'block' : 'none'};" src="${img}" />
    <div class="step-buttons" style="margin-top:10px;">
      <button class="btn delete" onclick="deleteStep(this)">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —à–∞–≥</button>
    </div>
  `;
  stepsContainer.appendChild(stepDiv);
  updateStepNumbers();
}

async function handleJsonDraft(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      document.getElementById('title').value = data.title || '';
      document.getElementById('description').value = data.description || '';
      document.getElementById('additionalInfo').value = data.additional || '';
      document.getElementById('steps').innerHTML = '';
      stepCount = 0;
      (data.steps || []).forEach(step => {
        addStepFromDraft(step.title, step.desc, step.img);
      });
    } catch (err) {
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–Ω–æ–≤–∏–∫–∞: ' + err.message);
    }
  };
  reader.readAsText(file);
}

function downloadJsonDraft() {
  const title = document.getElementById('title').value;
  const description = document.getElementById('description').value;
  const additionalInfo = document.getElementById('additionalInfo').value;
  const steps = document.querySelectorAll('.step');

  const json = {
    title,
    description,
    additional: additionalInfo,
    steps: []
  };

  steps.forEach((step) => {
    const stepTitle = step.querySelector('input[type="text"]').value;
    const stepDesc = step.querySelector('textarea').value;
    const imgLink = step.querySelector('.resultLink a');
    const img = imgLink ? imgLink.href : '';
    json.steps.push({ title: stepTitle, desc: stepDesc, img });
  });

  const blob = new Blob([JSON.stringify(json, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = (title ? title.replace(/[^a-z0-9–∞-—è—ë_\- ]/gi, '').slice(0, 70) : 'instruction') + '.json';
  a.click();
  URL.revokeObjectURL(url);
}
  </script>
  <script>
   ;

  steps.forEach((step) => {
    const stepTitle = step.querySelector('input[type="text"]').value;
    const stepDesc = step.querySelector('textarea').value;
    const imgLink = step.querySelector('.resultLink a');
    const img = imgLink ? imgLink.href : '';
    json.steps.push({ title: stepTitle, desc: stepDesc, img });
  });

  const blob = new Blob([JSON.stringify(json, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const filename = (title ? title.replace(/[^a-z0-9–∞-—è—ë_\- ]/gi, '').slice(0, 70) : 'instruction') + '_—á–µ—Ä–Ω–æ–≤–∏–∫.json';
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}
  </script>
  <script>
   function sanitizeStepTitle(title, index) {
  return title.trim() || "–®–∞–≥ " + (index + 1);
}

function sanitizeStepDesc(desc, img) {
  if (desc.trim().match(/^!\[.*?\]\(.*?\)/)) return '';
  return desc.trim();
}

;

  steps.forEach((step, i) => {
    let stepTitle = step.querySelector('input[type="text"]').value;
    let stepDesc = step.querySelector('textarea').value;
    const imgLink = step.querySelector('.resultLink a');
    const img = imgLink ? imgLink.href : '';

    stepTitle = sanitizeStepTitle(stepTitle, i);
    stepDesc = sanitizeStepDesc(stepDesc, img);

    json.steps.push({ title: stepTitle, desc: stepDesc, img });
  });

  const blob = new Blob([JSON.stringify(json, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const filename = (title ? title.replace(/[^a-z0-9–∞-—è—ë_\- ]/gi, '').slice(0, 70) : 'instruction') + '_—á–µ—Ä–Ω–æ–≤–∏–∫.json';
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}
  </script>
  <script>
   function parseMdToJson(md) {
  const titleMatch = md.match(/# (.+)/);
  const descMatch = md.match(/> (.+)/);
  const additionalMatch = md.match(/## ‚ÑπÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è\n\n([\s\S]+)/);

  const steps = [];
  const stepRegex = /### (\d+)\. (.+?)\n\n([\s\S]+?)(?:\n\n!\[.*?\]\((.*?)\))?\n\n---/g;
  let match;
  while ((match = stepRegex.exec(md)) !== null) {
    steps.push({
      title: match[2].trim(),
      desc: match[3].trim(),
      img: match[4] ? match[4].trim() : ""
    });
  }

  return {
    title: titleMatch ? titleMatch[1].trim() : '',
    description: descMatch ? descMatch[1].trim() : '',
    additional: additionalMatch ? additionalMatch[1].trim() : '',
    steps
  };
}

async function handleJsonDraft(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      let data;
      if (file.name.endsWith('.json')) {
        data = JSON.parse(e.target.result);
      } else if (file.name.endsWith('.md')) {
        data = parseMdToJson(e.target.result);
      } else {
        throw new Error('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
      }

      document.getElementById('title').value = data.title || '';
      document.getElementById('description').value = data.description || '';
      document.getElementById('additionalInfo').value = data.additional || '';
      document.getElementById('steps').innerHTML = '';
      stepCount = 0;
      (data.steps || []).forEach(step => {
        addStepFromDraft(step.title, step.desc, step.img);
      });
    } catch (err) {
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–Ω–æ–≤–∏–∫–∞: ' + err.message);
    }
  };
  reader.readAsText(file);
}
  </script>
 </body>
</html>
